name: Repository Template

on:
  workflow_dispatch:

  workflow_call:
    inputs:
      jinja2-input-data:
        required: true
        type: string
      jinja2-input-template-file:
        required: true
        type: string
      jinja2-output-file:
        required: true
        type: string
      commit-message:
        required: true
        type: string

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Get npm cache directory
        id: npm-cache-dir
        run: |
          echo "::set-output name=dir::$(npm config get cache)"

      - uses: actions/cache@v3
        id: npm-cache # use this to check for `cache-hit` ==> if: steps.npm-cache.outputs.cache-hit != 'true'
        with:
          path: ${{ steps.npm-cache-dir.outputs.dir }}
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Repository Template
        run: |
          pip install jinja2-cli
          REPOSITORY_NAME=$(basename $GITHUB_REPOSITORY)
          jinja2 --strict ${{ inputs.jinja2-input-data }} ${{ inputs.jinja2-input-template-file }} > ${{ inputs.jinja2-output-file }}
        shell: dash -e {0}

      - name: Pull Current Changes
        run: |
          git pull --rebase --autostash
        shell: dash -e {0}

      - name: Committing Changes
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: ${{ inputs.commit-message }}
